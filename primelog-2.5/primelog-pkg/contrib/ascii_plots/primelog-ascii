#!/usr/bin/env bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# primelog-ascii  â€”  PrimeLog ç»ˆç«¯ ASCII å¯è§†åŒ–
#
# ç”¨æ³•ï¼š
#   primelog-ascii errors     [events.json]
#   primelog-ascii timeseries [events.json] [bin_size_sec]
#   primelog-ascii heatmap    [events.json] [adj.json]
#   primelog-ascii fft        [events.json] [bin_size_sec]
#   primelog-ascii all        [log_dir]
#
# å¯é€‰ï¼šæœ«å°¾åŠ  --lolcat å¼€å¯å½©è™¹ä¸Šè‰² ğŸŒˆ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WL_DIR="$SCRIPT_DIR/wl_bridge"
PY_DIR="$SCRIPT_DIR/py_plots"

# â”€â”€ ä¾èµ–æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
need() {
    command -v "$1" &>/dev/null || { echo "âŒ éœ€è¦ $1ï¼Œè¯·å…ˆå®‰è£…"; exit 1; }
}
need wolfram
need python3

USE_LOLCAT=false
if [[ "${@: -1}" == "--lolcat" ]]; then
    command -v lolcat &>/dev/null && USE_LOLCAT=true || echo "âš ï¸  lolcat æœªå®‰è£…ï¼Œè·³è¿‡ä¸Šè‰²"
    set -- "${@:1:$(($#-1))}"   # å»æ‰æœ€åä¸€ä¸ªå‚æ•°
fi

pipe_out() {
    if $USE_LOLCAT; then
        lolcat
    else
        cat
    fi
}

# â”€â”€ è‡ªåŠ¨æ‰¾æœ€æ–°æ–‡ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
find_latest() {
    local pattern="$1"
    local dir="${2:-.}"
    ls -t "$dir"/$pattern 2>/dev/null | head -1
}

# â”€â”€ å­å‘½ä»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cmd="${1:-help}"
shift || true

case "$cmd" in

errors)
    evfile="${1:-$(find_latest 'error_events_*.json')}"
    [[ -f "$evfile" ]] || { echo "âŒ æ‰¾ä¸åˆ° error_events_*.json"; exit 1; }
    echo "ğŸ“Š é”™è¯¯åˆ†å¸ƒ  â† $evfile"
    wolfram -script "$WL_DIR/errors.wl" "$evfile" \
      | python3 "$PY_DIR/errors.py" \
      | pipe_out
    ;;

timeseries)
    evfile="${1:-$(find_latest 'error_events_*.json')}"
    binsize="${2:-1.0}"
    [[ -f "$evfile" ]] || { echo "âŒ æ‰¾ä¸åˆ° error_events_*.json"; exit 1; }
    echo "ğŸ“ˆ æ—¶é—´åºåˆ—  â† $evfile  (bin=${binsize}s)"
    wolfram -script "$WL_DIR/timeseries.wl" "$evfile" "$binsize" \
      | python3 "$PY_DIR/timeseries.py" \
      | pipe_out
    ;;

heatmap)
    evfile="${1:-$(find_latest 'error_events_*.json')}"
    adjfile="${2:-$(find_latest 'adjacency_matrix_*.json')}"
    [[ -f "$evfile" && -f "$adjfile" ]] || { echo "âŒ æ‰¾ä¸åˆ°æ‰€éœ€ JSON æ–‡ä»¶"; exit 1; }
    echo "ğŸŒ¡ï¸  çƒ­åŠ›å›¾  â† $evfile + $adjfile"
    wolfram -script "$WL_DIR/heatmap.wl" "$evfile" "$adjfile" \
      | python3 "$PY_DIR/heatmap.py" \
      | pipe_out
    ;;

fft)
    evfile="${1:-$(find_latest 'error_events_*.json')}"
    binsize="${2:-0.5}"
    [[ -f "$evfile" ]] || { echo "âŒ æ‰¾ä¸åˆ° error_events_*.json"; exit 1; }
    echo "ğŸµ FFT é¢‘è°±  â† $evfile  (bin=${binsize}s)"
    wolfram -script "$WL_DIR/fft.wl" "$evfile" "$binsize" \
      | python3 "$PY_DIR/fft.py" \
      | pipe_out
    ;;

all)
    dir="${1:-.}"
    evfile="$(find_latest 'error_events_*.json' "$dir")"
    adjfile="$(find_latest 'adjacency_matrix_*.json' "$dir")"
    [[ -f "$evfile" ]] || { echo "âŒ $dir ä¸‹æ‰¾ä¸åˆ°æ—¥å¿—æ–‡ä»¶"; exit 1; }

    for sub in errors timeseries fft; do
        echo ""
        "$BASH_SOURCE" "$sub" "$evfile" | pipe_out
    done

    if [[ -f "$adjfile" ]]; then
        echo ""
        "$BASH_SOURCE" heatmap "$evfile" "$adjfile" | pipe_out
    fi
    ;;

help|--help|-h)
    cat << 'HELP'
primelog-ascii â€” PrimeLog ç»ˆç«¯å¯è§†åŒ–

  errors     [events.json]               é”™è¯¯ç±»å‹åˆ†å¸ƒæŸ±çŠ¶å›¾
  timeseries [events.json] [bin_sec]     é”™è¯¯éšæ—¶é—´å˜åŒ–æŠ˜çº¿å›¾
  heatmap    [events.json] [adj.json]    ç»„ä»¶é—´é”™è¯¯çƒ­åŠ›å›¾
  fft        [events.json] [bin_sec]     é”™è¯¯ä¿¡å· FFT é¢‘è°±
  all        [log_dir]                   ä¾æ¬¡è¿è¡Œå…¨éƒ¨å›¾è¡¨

åŠ  --lolcat å¼€å¯å½©è™¹ä¸Šè‰² ğŸŒˆï¼ˆéœ€è¦å®‰è£… lolcatï¼‰

ç¤ºä¾‹ï¼š
  cd logs/my-project
  primelog-ascii all .
  primelog-ascii errors --lolcat
  primelog-ascii timeseries error_events_20260223.json 2.0
HELP
    ;;

*)
    echo "æœªçŸ¥å‘½ä»¤: $cmd  (è¿è¡Œ primelog-ascii help æŸ¥çœ‹ç”¨æ³•)"
    exit 1
    ;;
esac
