#!/usr/bin/env python3
"""集成测试：验证关系类型编码与导出"""

import primelog
import time

# 初始化项目
primelog.init('test-project')

# 注册两个组件
@primelog.component('test-project.compA', type_='test', signature='call_b()')
class CompA:
    def call_b(self, should_fail=False):
        # 正常调用，使用默认关系类型（internal.sync）
        b = primelog.registry.get_service('test-project.compB')
        return b.do_something(should_fail)

@primelog.component('test-project.compB', type_='test', signature='do_something()')
class CompB:
    def do_something(self, should_fail=False):
        if should_fail:
            raise ValueError("模拟异常")
        return "ok"

# 手动触发组件上下文（因为get_service已经包装了，但为了测试不同关系类型，我们可以显式使用上下文）
from primelog.core.registry import registry

# 正常调用，使用默认关系类型
a = CompA()
result = a.call_b(should_fail=False)
print(f"正常调用结果: {result}")

# 模拟一个RPC类型的调用（假设通过context传入）

# 异常调用
try:
    a.call_b(should_fail=True)
except ValueError:
    print("捕获到预期异常")

# 导出日志
primelog.export()
print("测试完成，请检查导出的日志文件。")